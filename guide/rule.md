# CPU 目标检查（ CPU 目标跟踪伸缩 ）

您可以通过，弹性伸缩 ( UAS ) 控制台，伸缩组的详情，规则信息部分，
查看 CPU 目标检查是否开启。

![规则信息](/images/rule.png)

通过点击更改规则修改相关设置。 包括开启与关闭，以及目标值。

![更改规则](/images/rule_2.png)

## CPU 目标跟踪伸缩策略

CPU 目标跟踪伸缩策略根据伸缩组内云主机的 CPU 使用率，自动调整实例数量，维持设定的目标 CPU 使用率。

### 工作原理

#### 基本计算公式

系统定期采集伸缩组内所有云主机的 CPU 指标，并通过以下公式计算期望的实例数：

```
期望实例数 = ⌈所有实例 CPU 使用率之和 / 目标 CPU 使用率⌉
```

**计算示例：**
- 当前 3 台云主机，各自 CPU 使用率：60%、70%、80%
- 目标 CPU 使用率：50%
- 计算：⌈(60 + 70 + 80) / 50⌉ = ⌈210 / 50⌉ = 5
- 系统将扩容至 5 台云主机

#### 伸缩决策流程

1. **指标采集**：收集伸缩组内所有云主机的 CPU 指标
2. **指标过滤**：仅统计状态为 RUNNING 的健康主机
3. **计算期望值**：
   - 扩容规则：基于 ScaleUp 的目标值计算扩容后的实例数
   - 缩容规则：基于 ScaleDown 的目标值计算缩容后的实例数
4. **边界检查**：确保结果在最小/最大实例数范围内
5. **执行伸缩**：创建或终止相应数量的实例
6. **冷却等待**：进入冷却期，避免频繁伸缩

### 规则配置

#### 基础配置

| 配置项 | 说明 | 默认值 | 取值范围 |
|-------|------|--------|----------|
| 最小实例数 (MinReplicas) | 伸缩组最少保持的实例数量 | 1 | ≥ 1 |
| 最大实例数 (MaxReplicas) | 伸缩组最多可扩展的实例数量 | 10 | > 最小实例数 |
| 默认伸缩周期 (DefaultScalePeriod) | 默认的伸缩冷却时间（秒） | 300 | > 0 |
| 指标名称 (HostMetrics) | 监控的指标类型 | ["cpu"] | - |

#### 扩缩容行为配置

系统支持独立配置扩容和缩容的行为：

**扩容配置 (ScaleUp)**
| 配置项 | 说明 | 示例值 |
|-------|------|--------|
| 目标使用率 (TargetUtilization) | 触发扩容的 CPU 阈值 | 70% |
| 伸缩周期 (ScalePeriod) | 扩容后的冷却时间（秒） | 60 |

**缩容配置 (ScaleDown)**
| 配置项 | 说明 | 示例值 |
|-------|------|--------|
| 目标使用率 (TargetUtilization) | 触发缩容的 CPU 阈值 | 30% |
| 伸缩周期 (ScalePeriod) | 缩容后的冷却时间（秒） | 300 |

### 伸缩行为详解

#### 正常伸缩场景

**扩容触发条件：**
- 当前实例数在最小/最大范围内
- 所有健康实例的 CPU 总和超过 (当前实例数 × 扩容目标值)
- 不在冷却期内

**缩容触发条件：**
- 当前实例数在最小/最大范围内
- 所有健康实例的 CPU 总和低于 (期望实例数 × 缩容目标值)
- 期望实例数小于当前实例数
- 不在冷却期内

#### 边界调整场景

当实例数超出配置的最小/最大限制时，系统会立即调整，不受 CPU 使用率影响：

- **低于最小值**：立即扩容至最小实例数
- **高于最大值**：立即缩容至最大实例数

这种调整会标记为 "主机数量区间" 类型的伸缩事件。

### 特殊机制

#### 1. 冷却时间机制
- 每次伸缩后进入冷却期，期间不执行新的伸缩操作
- 冷却时间可针对扩容和缩容独立配置
- 未配置时使用默认伸缩周期

#### 2. 指标过滤机制
- 仅统计状态为 RUNNING 的云主机指标
- 排除正在启动、停止或故障的主机
- 确保伸缩决策基于健康实例的真实负载

#### 3. 多指标支持
- 支持同时监控多个指标（如 CPU、内存）
- 当存在多个指标时，选择需要实例数最多的指标结果
- 保证所有指标都满足目标要求

#### 4. 伸缩事件记录
系统会记录每次伸缩活动：
- **扩容事件**：记录触发类型（CPU/主机数量区间）、增加数量、新旧实例数
- **缩容事件**：记录触发类型、减少数量、新旧实例数

### 最佳实践

1. **合理设置扩缩容阈值**
   - 扩容阈值建议：60-80%
   - 缩容阈值建议：20-40%
   - 避免阈值过于接近，防止频繁伸缩

2. **优化冷却时间**
   - 扩容冷却时间：根据应用启动时间设置，通常 60-180 秒
   - 缩容冷却时间：设置较长时间（300-600 秒），避免过早缩容

3. **设置合理的实例数范围**
   - 最小实例数：确保基本业务可用性
   - 最大实例数：控制成本，防止异常扩容

4. **监控和调优**
   - 定期查看伸缩事件日志
   - 分析伸缩频率和触发原因
   - 根据实际业务负载调整参数

### 注意事项

- CPU 指标值为整数百分比（0-100）
- 目标使用率必须在 1-100 之间
- 伸缩决策基于最近一个采集周期的指标
- 当 Autoscaler 状态为 Terminated 时，将自动清理资源
- 伸缩组状态非 Created 时，暂停伸缩操作
